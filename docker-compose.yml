services:
  qdrant:
    image: qdrant/qdrant:v1.15.1
    container_name: ragx_qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage  # Docker managed - najbardziej stabilne
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__LOG_LEVEL: INFO
      QDRANT__SERVICE__MAX_REQUEST_SIZE_MB: 256

      QDRANT__STORAGE__PERFORMANCE__MAX_OPTIMIZATION_THREADS: 8
      QDRANT__STORAGE__OPTIMIZERS__MAX_SEGMENT_SIZE_KB: 200000
      QDRANT__STORAGE__OPTIMIZERS__INDEXING_THRESHOLD_KB: 20000
      QDRANT__STORAGE__OPTIMIZERS__FLUSH_INTERVAL_SEC: 10

      # WSZYSTKO on-disk = snapshoty będą kompletne
      QDRANT__STORAGE__ON_DISK_PAYLOAD: "true"
      QDRANT__STORAGE__HNSW_INDEX__ON_DISK: "true"
      QDRANT__STORAGE__PERFORMANCE__OPTIMIZERS__DEFAULT_VECTOR_ON_DISK: "true"

      QDRANT__STORAGE__HNSW_INDEX__M: 16
      QDRANT__STORAGE__HNSW_INDEX__EF_CONSTRUCT: 100
      QDRANT__STORAGE__WAL__WAL_CAPACITY_MB: 64

    deploy:
      resources:
        limits:
          memory: 20G
        reservations:
          memory: 12G

volumes:
  qdrant_data:

networks:
  default:
    name: ragx_network